<html>  
  <head>  
        <meta charset="utf-8">  
        <title>纽约地图</title>  
  </head> 
<style>

</style>
<body>
<script src="bower_components/d3/d3.min.js"></script>
<script src="bower_components/jQuery/dist/jquery.min.js"></script>
<script src="bower_components/heatmap.js-amd/build/heatmap.js"></script>

<body>
 <div id="heatmap">
	<canvas id ="heatmapcanvas" width="2500" height="1500" ></canvas>
</canvas>

 </div>
</body>


<script>


	var width  = 2500;
	var height = 1500;

	/* var svg = d3.select("body").append("svg")
      .attr("id", "map")
	    .attr("width", width)
	    .attr("height", height); */
		
	var canvas = document.getElementById("heatmapcanvas");
	var context = canvas.getContext("2d");
	
	var projection = d3.geo.mercator()
      .scale(500000)
      .rotate([74, -40 - 45 / 60, 130])
	    .translate([width/2, height/3]);
		
	
	
	d3.json("nta.geojson", function(error, map) {
		//console.log(map.features[0]["geometry"]["coordinates"]);
		var Manhattan = [];
		for(var index = 0; index < map.features.length; index++){
			if(map["features"][index]["properties"]["BoroName"] == "Manhattan")
				Manhattan.push(map.features[index]);
		}
		
		Manhattan.forEach(function(data) {
			context.beginPath();
			context.strokeStyle = "black";
			context.moveTo(
			Math.floor( projection([data["geometry"]["coordinates"][0][0][0], data["geometry"]["coordinates"][0][0][1] ])[0]) ,
			Math.floor( projection([data["geometry"]["coordinates"][0][0][0], data["geometry"]["coordinates"][0][0][1] ])[1])
			);
			for(var index = 1; index < data["geometry"]["coordinates"][0].length; index++){
				context.lineTo(
					Math.floor(projection([data["geometry"]["coordinates"][0][index][0], data["geometry"]["coordinates"][0][index][1]]) [0]) ,
					Math.floor(projection([data["geometry"]["coordinates"][0][index][0], data["geometry"]["coordinates"][0][index][1]])[1])
					);
			}
			context.fillStyle = "Beige";
			context.fill();
			context.closePath();
			context.stroke();
		});
    
		//map["features"][index]["geometry"]["coordinates"];
		//console.log(Manhattan);		
		// svg.append("g")
		// 	.attr("class", "NTA")
		// 	.selectAll("path")
		// 	.data( Manhattan )
		// 	.enter()
		// 	.append("path")
		// 	.attr("stroke","#000")
		// 	.attr("stroke-width",1)
		// 	.attr("fill", "#FFF8D7")
		// 	.attr("d", path );
			
	});
	
	d3.tsv("taxi_count2", function(eooro, data){

		var heatmapInstance = h337.create({
       // only container is required, the rest will be defaults
        container: document.querySelector("#heatmap"),
        radius: 27
			/* gradient: {
			// enter n keys between 0 and 1 here
			// for gradient color customization
			'.000005': 'Blue',
			'.2': 'yellow',
			'.5': 'Lime',
			'.6': 'red'
		  }  */
       });
       var points = [];
       var counts = [];
       var max = 0;

       for(var index = 0; index < data.length; index++){
         counts.push(data[index]["count"]);
       }

     var linear = d3.scale.linear()
         .domain([0, d3.max(counts)])
         .range([0, 1]);
       for(var index = 0; index < data.length; index++){
         var val = linear(data[index]["count"]);
         max = Math.max(max, val);
         var point = {
           x: Math.floor(projection([data[index]["log"], data[index]["lat"]])[0]),
           y: Math.floor(projection([data[index]["log"], data[index]["lat"]])[1]),
           value: val
         };
         points.push(point);
       }
       var data = { 
       max: max, 
       data: points 
       };
       console.log(data);
       heatmapInstance.setData(data); 
	   
   });
	
	
	/* d3.tsv("review_coord.txt", function(eooro, data1){
		d3.tsv("traffic_coord.txt", function(eooro, data2){
		var restaurant = [];
		var restaurant_traffic = [];
		var both = [];
		
		for(var index1 = 0; index1 < data1.length; index1++){
			var x1 = Math.floor(projection([data1[index1]["log"], data1[index1]["lat"]])[0]);
			var y1 = Math.floor(projection([data1[index1]["log"], data1[index1]["lat"]])[1]);
			var flag = false;
			for(var index2 = 0; index2 < data2.length; index2++){
				var x2 = Math.floor(projection([data2[index2]["log"], data2[index2]["lat"]])[0]);
				var y2 = Math.floor(projection([data2[index2]["log"], data2[index2]["lat"]])[1]);
				if(x1 == x2 && y1 == y2){
					flag = true;
				}
			}
			if(!flag)
				restaurant.push(data1[index1]);
			else
				both.push(data1[index1]);
		}
		
		for(var index1 = 0; index1 < data2.length; index1++){
			var x1 = Math.floor(projection([data2[index1]["log"], data2[index1]["lat"]])[0]);
			var y1 = Math.floor(projection([data2[index1]["log"], data2[index1]["lat"]])[1]);
			var flag = false;
			for(var index2 = 0; index2 < data1.length; index2++){
				var x2 = Math.floor(projection([data1[index2]["log"], data1[index2]["lat"]])[0]);
				var y2 = Math.floor(projection([data1[index2]["log"], data1[index2]["lat"]])[1]);
				if(x1 == x2 && y1 == y2){
					flag = true;
				}
			}
			if(!flag)
				restaurant_traffic.push(data2[index1]);
		}
		
		var drawPoint = function(data, color) { 
		   for(var index = 0; index < data.length; index++){
				context.beginPath();
				context.strokeStyle = "black";
				context.arc(Math.floor(projection([data[index]["log"], data[index]["lat"]])[0]),
							Math.floor(projection([data[index]["log"], data[index]["lat"]])[1]),5,0,360,false);
				context.fillStyle = color;
				context.fill();
				context.stroke();
				context.closePath();
				
		   }
		};
		
		drawPoint(restaurant, "Red");
		drawPoint(restaurant_traffic, "Aqua");
		drawPoint(both, "Chartreuse");
		}); 
   }); */
   



d3.select('html') // Selects the 'html' element
  .on('mousemove', function()
    {
		var locs=d3.mouse(this);	// get the mouse coordinates
		// add some padding
		locs[0]+=15;
		locs[1]+=5;
		$("div.mouseover").css("margin-left",locs[0]);
		$("div.mouseover").css("margin-top",locs[1]);
    });
</script>
	
<style>
.counties {
  fill: none;
}
.NTA {
  
  stroke: #fff;
  stroke-linejoin: round;
  fill:rgb(107,174,214); 
}
    
div.mouseover{
	position: absolute;
	background: black;
	background-color: rgba(0,0,0,0.5);
	border: 1px solid #131313;
	color: white;
	padding: 5px 8px;
	margin-left: 100px;
	margin-top: 50px;
	display: none;
}

</style>
</html>  